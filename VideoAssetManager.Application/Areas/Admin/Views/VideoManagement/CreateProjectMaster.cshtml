@model VM_Project
@inject VideoAssetManager.DataAccess.VideoAssetManagerDBContext _VideoAssetManagerDBContext
@{
    VideoAssetManager.DataAccess.Repository.QuickLinksRepository ql = new VideoAssetManager.DataAccess.Repository.QuickLinksRepository(_VideoAssetManagerDBContext);

    ViewData["Title"] = "Create Project";

    var Id = 0;
    if (Model != null)
    {
        Id = Model.Id;
    }
}

<style>
    .ck.ck-content {
        max-height: 250px;
    }
    button.multiselect.dropdown-toggle.btn.btn-default {
        background: #fff;
    }
    #StagesGuid {
        width: 380px;
    }

    .multiselect-search {
        display: block;
        width: 100%;
    }

    .dropdown-menu.show {
        display: block;
        width: 100%;
    }

    #SearchKeyword {
        max-width: 100%
    }
</style>
<div class="PageCaption">
    <div class="col-md-12 text-left">
        <a class="btn btn-primary float-right" asp-area="admin" asp-action="ProjectMasterIndex" asp-controller="VideoManagement" title="Manage Project">Manage Project</a>
    </div>
</div>
<div class="container">

    <div class="row">
        <div class="col-md-6 offset-md-3" id="BasicInformation">
            <section>
                <form method="post" asp-controller="VideoManagement" asp-action="CreateProjectMaster" id="frmStage" enctype="multipart/form-data">
                    <input type="hidden" asp-for="Id" id="Id" name="Id" />

                    @await Html.PartialAsync("_FormInput", Tuple.Create("Name", "Name", Model?.Name ?? "", true, "text", ""))

                    @await Html.PartialAsync("_FormInput", Tuple.Create("Code", "Code", Model?.Code ?? "", true, "text", ""))

                    <div class="form-group">
                        <b><label class="required">Type</label></b>
                        @if (Model != null && Model.Id > 0)
                        {
                            <select asp-for="Type" class="form-control" id="Type" asp-items="ViewBag.TypeList" disabled>
                                <option value="">-- Select Type --</option>
                            </select>
                            <input type="hidden" asp-for="Type" />
                        }
                        else
                        {
                            <select asp-for="Type" class="form-control" id="Type" asp-items="ViewBag.TypeList" required>
                                <option value="">-- Select Type --</option>
                            </select>
                        }
                        <span asp-validation-for="Type" class="text-danger"></span>
                    </div>

                    <div class="form-group" id="EventDropdownGroup" style="display:none;">
                        <b><label>Event</label></b>
                        <select asp-for="Event" class="form-control" id="Event" asp-items="ViewBag.EventList">
                            <option value="">--Select Event--</option>
                        </select>
                        <span asp-validation-for="Event" class="text-danger"></span>
                    </div>

                    <div class="form-group" id="StageDropdownGroup" style="display:none;">
                        <b><label>Stage</label></b><br />
                        <select id="StagesGuid" multiple="multiple" name="StagesGuid" class="form-control">
                            @if (ViewBag.stagesList != null)
                            {
                                foreach (var item in ViewBag.stagesList)
                                {
                                    if (ql.GetStageId(item.StageId, Id))
                                    {
                                        <option value="@item.StageId" selected="selected">
                                            @item.Name
                                        </option>
                                    }
                                    else
                                    {
                                        <option value="@item.StageId">
                                            @item.Name
                                        </option>
                                    }
                                }
                            }
                        </select>
                        <br />
                        <span class="text-danger" id="ValidateStage"></span>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary mb-1">Save</button>
                    </div>
                </form>
            </section>
        </div>
    </div>
</div>

@section Scripts{
    @{
        <partial name="_ValidationScriptsPartial" />
    }
}

<script>
    $(document).ready(function () {
        $("#clsCaption").html("Add Project");

        $('#StagesGuid').multiselect({
            includeSelectAllOption: true,
            selectAllValue: 'multiselect-all',
            enableFiltering: true,
            enableCaseInsensitiveFiltering: true,           
            buttonWidth: '530'
        });        
   
    $('#Type').change(function () {
        if ($(this).val() == '1') {
            $('#EventDropdownGroup').show();
            $('#Event').prop('required', true);
        } else {
           
            $('#Event').val(''); 
            $('#StagesGuid').val(null).trigger('change');
            $('#StagesGuid').multiselect('refresh');

            // Hide elements
            $('#EventDropdownGroup').hide();
            $('#StageDropdownGroup').hide();

            // Remove required attributes
            $('#Event').prop('required', false);
            $('#StagesGuid').prop('required', false);
        }
    }).trigger('change');

    $('#Event').change(function () {
     
        const selectedValue = $(this).val();
        const validValues = ['1', '2', '3'];

        if (validValues.includes(selectedValue)) {
            $('#StageDropdownGroup').show();
            $('#StagesGuid').prop('required', true);
        } else {
            $('#StageDropdownGroup').hide();
            $('#StagesGuid').prop('required', false);
            $('#StagesGuid').val(null).trigger('change'); 
            $('#StagesGuid').multiselect('refresh'); 
        }
    }).trigger('change');

        $('form').on('submit', function (e) {
            
            var val = $('#Code').val();
            var errorSpan = $("[data-valmsg-for='Code']");
            
            if (val.length !== 5) {
                alert('The Code must be exactly 5 characters long.');
                //errorSpan.text('The Code must be exactly 5 characters long.');
                //errorSpan.addClass('field-validation-error').removeClass('field-validation-valid');
                e.preventDefault(); // Stop form submission
                return false;
            } else {
                errorSpan.text('');
                errorSpan.addClass('field-validation-valid').removeClass('field-validation-error');
            }
        });
                
        $('#Code').on('input change blur', function () {
            var val = $(this).val();
            var errorSpan = $("[data-valmsg-for='Code']");

            if (val.length !== 5) {
                errorSpan.text('The Code must be exactly 5 characters long.');
                errorSpan.addClass('field-validation-error').removeClass('field-validation-valid');
                
            } else {
                errorSpan.text('');
                errorSpan.addClass('field-validation-valid').removeClass('field-validation-error');
            }
        });

    });
        
</script>